<script type="text/javascript">

    function defaultNameFromUI() {
        var tagName = $("#node-input-tag option:selected").text();
        var sensor = $("#node-input-sensor option:selected").text();
        if (tagName && sensor) {
            return tagName +" ("+ sensor +")";
        }
        return "Wireless Tag";
    }

    RED.nodes.registerType('wirelesstag', {
        category: 'hardware',
        color: '#a6bbcf',
        defaults: {
            tagmanager: { required: true, value: "" },
            tag: { required: true, value: "" },
            sensor: { required: true, value: "" },
            name: { value: "" },
            topic: { value: "" },
            topicIsPrefix: { value: false },
            defaultName: { value: "" }, // this is computed, hidden in UI
            cloud: { value: "", type: "wirelesstag-config" }
        },
        inputs: 0,
        outputs: 1,
        icon: "wirelesstag-inv.png",
        label: function() {
            if (this.name) return this.name;
            if (this.defaultName) return this.defaultName;
            return "Wireless Tag";
        },
        oneditprepare: function() {
            var mountpoint = "/wirelesstag";
            var prefix;
            var node = this;

            function restoreSelected(elemId, selVal) {
                if (! selVal) return;
                $(elemId).find("option[value='"+selVal+"']").prop('selected', true);
            }

            // blank out name input if value is equal to the computed name
            if (this.name === this.defaultName) $("#node-input-name").val('');

            // on setting (or changing) the cloud connection, repopulate
            // tag manager selection
            $("#node-input-cloud").on("change", function(evt) {
                var cloud = $("#node-input-cloud").val();
                if (cloud === "_ADD_") return;
                prefix = mountpoint + "/" + cloud;
                $.get(prefix + "/tagmanagers", function(tagManagers) {
                    var selMgr =
                        $("#node-input-tagmanager").val() || node.tagmanager;
                    $("#node-input-tagmanager").empty();
                    $.each(tagManagers, function(mac, name) {
                        $("#node-input-tagmanager").append('<option value="'+mac+'">'+name+'</option>');
                    });
                    restoreSelected("#node-input-tagmanager", selMgr);
                    $("#node-input-tagmanager").change();
                }).fail(function(jqXHR) {
                    $("#node-input-sensor").empty();
                    $("#node-input-tag").empty();
                    $("#node-input-tagmanager").empty();
                    RED.notify("Unable to populate selection lists ("
                               + jqXHR.status + " - " + jqXHR.statusText + "): "
                               + jqXHR.responseText,
                               "error", false, 6000);
                });
            });

            // on selecting (or changing) the tag manager, repopulate
            // the selection of associated tags
            $("#node-input-tagmanager").on("change", function(evt) {
                var mac = $(evt.target).val();
                if (mac === null) return;
                var selTag = $("#node-input-tag").val() || node.tag;
                $.get(prefix + "/" + mac + "/tags", function(tags) {
                    $("#node-input-tag").empty();
                    $.each(tags, function(uuid, name) {
                        $("#node-input-tag").append('<option value="'+uuid+'">'+name+'</option>');
                    });
                    restoreSelected("#node-input-tag", selTag);
                    $("#node-input-tag").change();
                });
            });

            // on selecting (or changing) the tag, repopulate the tag's sensors
            $("#node-input-tag").on("change", function(evt) {
                var uuid = $(evt.target).val();
                if (uuid === null) return;
                var mac = $("#node-input-tagmanager").val();
                var selSensor = $("#node-input-sensor").val() || node.sensor;
                $.get(prefix +"/"+ mac +"/"+ uuid +"/sensors", function(sensors) {                    
                    $("#node-input-sensor").empty();
                    sensors.forEach(function(s) {
                        $("#node-input-sensor").append('<option value="'+s+'">'+s+'</option>');
                    });
                    restoreSelected("#node-input-sensor", selSensor);
                });
            });

            // if a topic is entered manually, ask whether it is to be
            // used as a prefix
            $("#node-input-topic").on("change", function(evt) {
                var topic = $(evt.target).val();
                if (topic) {
                    $("#node-topicIsPrefix").show();
                } else {
                    $("#node-topicIsPrefix").hide();
                }
            });
        },
        oneditsave: function() {
            var defaultName = defaultNameFromUI();
            $("#node-input-defaultName").val(defaultName);
            if (! $("#node-input-name").val()) {
                $("#node-input-name").val(defaultName);
            }
        }
    });

</script>

<script type="text/x-red" data-template-name="wirelesstag">
    <div class="form-row">
        <label for="node-input-cloud"><i class="fa fa-globe"></i> Cloud (API)</label>
        <input type="text" id="node-input-cloud">
    </div>
    <div class="form-row">
        <label for="node-input-tagmanager"><i class="fa fa-rss"></i> Tag Manager</label>
        <select type="text" id="node-input-tagmanager"></select>
    </div>
    <div class="form-row">
        <label for="node-input-tag"><i class="fa fa-square-o"></i> Tag</label>
        <select type="text" id="node-input-tag"></select>
    </div>
    <div class="form-row">
        <label for="node-input-sensor"><i class="fa fa-bolt"></i> Sensor</label>
        <select type="text" id="node-input-sensor"></select>
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-input-topic" placeholder="Default">
    </div>
    <div class="form-row" id="node-topicIsPrefix">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-topicIsPrefix" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-topicIsPrefix" style="width: 70%;"> Use as prefix?</label>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Default">
        <input type="hidden" id="node-input-defaultName">
    </div>
</script>

<script type="text/x-red" data-help-name="wirelesstag">
    <p>A node that represents the sensor of a Wireless Tag (see <a
    href="http://wirelesstag.net" target="_blank">http://wirelesstag.net</a>)</p>
</script>
